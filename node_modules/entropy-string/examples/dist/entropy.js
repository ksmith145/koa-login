'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.charset2 = exports.charset4 = exports.charset8 = exports.charset16 = exports.charset32 = exports.charset64 = undefined;

var _log = require('babel-runtime/core-js/math/log2');

var _log2 = _interopRequireDefault(_log);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Crypto = require('crypto');
var WeakMap = require('weak-map');

var _require = require('./charset'),
    CharSet = _require.default;

var charset64 = exports.charset64 = new CharSet('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_');
var charset32 = exports.charset32 = new CharSet('2346789bdfghjmnpqrtBDFGHJLMNPQRT');
var charset16 = exports.charset16 = new CharSet('0123456789abcdef');
var charset8 = exports.charset8 = new CharSet('01234567');
var charset4 = exports.charset4 = new CharSet('ATCG');
var charset2 = exports.charset2 = new CharSet('01');

var propMap = new WeakMap();

var BITS_PER_BYTE = 8;

var endianByteNum = function () {
  var buf32 = new Uint32Array(1);
  var buf8 = new Uint8Array(buf32.buffer);
  buf32[0] = 0xff;
  return buf8[0] === 0xff ? [2, 3, 4, 5, 6, 7] : [0, 1, 2, 3, 6, 7];
}();

var _stringWithBytes = function _stringWithBytes(bitLen, bytes, charset) {
  if (bitLen <= 0) {
    return '';
  }

  var bitsPerChar = charset.getBitsPerChar();
  var count = Math.ceil(bitLen / bitsPerChar);
  if (count <= 0) {
    return '';
  }

  var need = Math.ceil(count * (bitsPerChar / BITS_PER_BYTE));
  if (bytes.length < need) {
    throw new Error('Insufficient bytes: need ' + need + ' and got ' + bytes.length);
  }

  var charsPerChunk = charset.getCharsPerChunk();
  var chunks = Math.floor(count / charsPerChunk);
  var partials = count % charsPerChunk;

  var ndxFn = charset.getNdxFn();
  var chars = charset.getChars();

  var string = '';
  for (var chunk = 0; chunk < chunks; chunk += 1) {
    for (var slice = 0; slice < charsPerChunk; slice += 1) {
      var ndx = ndxFn(chunk, slice, bytes);
      string += chars[ndx];
    }
  }
  for (var _slice = 0; _slice < partials; _slice += 1) {
    var _ndx = ndxFn(chunks, _slice, bytes);
    string += chars[_ndx];
  }
  return string;
};

var cryptoBytes = function cryptoBytes(count) {
  return Buffer.from(Crypto.randomBytes(count));
};

var randomBytes = function randomBytes(count) {
  var BYTES_USED_PER_RANDOM_CALL = 6;
  var randCount = Math.ceil(count / BYTES_USED_PER_RANDOM_CALL);

  var buffer = Buffer.alloc(count);
  var dataView = new DataView(new ArrayBuffer(BITS_PER_BYTE));
  for (var rNum = 0; rNum < randCount; rNum += 1) {
    dataView.setFloat64(0, Math.random());
    for (var n = 0; n < BYTES_USED_PER_RANDOM_CALL; n += 1) {
      var fByteNum = endianByteNum[n];
      var bByteNum = rNum * BYTES_USED_PER_RANDOM_CALL + n;
      if (bByteNum < count) {
        buffer[bByteNum] = dataView.getUint8(fByteNum);
      }
    }
  }
  return buffer;
};

var _class = function () {
  function _class(arg) {
    (0, _classCallCheck3.default)(this, _class);

    var charset = void 0;
    if (arg === undefined) {
      charset = charset32;
    } else if (arg instanceof CharSet) {
      charset = arg;
    } else if (typeof arg === 'string' || arg instanceof String) {
      charset = new CharSet(arg);
    } else {
      throw new Error('Invalid arg: must be either valid CharSet or valid chars');
    }
    var hideProps = {
      charset: charset
    };
    propMap.set(this, hideProps);
  }

  (0, _createClass3.default)(_class, [{
    key: 'smallID',
    value: function smallID() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : propMap.get(this).charset;

      return this.string(29, charset);
    }
  }, {
    key: 'mediumID',
    value: function mediumID() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : propMap.get(this).charset;

      return this.string(69, charset);
    }
  }, {
    key: 'largeID',
    value: function largeID() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : propMap.get(this).charset;

      return this.string(99, charset);
    }
  }, {
    key: 'sessionID',
    value: function sessionID() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : propMap.get(this).charset;

      return this.string(128, charset);
    }
  }, {
    key: 'token',
    value: function token() {
      var charset = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : propMap.get(this).charset;

      return this.string(256, charset);
    }
  }, {
    key: 'string',
    value: function string(bitLen) {
      var charset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : propMap.get(this).charset;

      var bytesNeeded = charset.bytesNeeded(bitLen);
      return this.stringWithBytes(bitLen, cryptoBytes(bytesNeeded), charset);
    }
  }, {
    key: 'stringRandom',
    value: function stringRandom(bitLen) {
      var charset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : propMap.get(this).charset;

      var bytesNeeded = charset.bytesNeeded(bitLen);
      return this.stringWithBytes(bitLen, randomBytes(bytesNeeded), charset);
    }
  }, {
    key: 'stringWithBytes',
    value: function stringWithBytes(bitLen, bytes) {
      var charset = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : propMap.get(this).charset;

      return _stringWithBytes(bitLen, bytes, charset);
    }
  }, {
    key: 'bytesNeeded',
    value: function bytesNeeded(bitLen) {
      var charset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : propMap.get(this).charset;

      return charset.bytesNeeded(bitLen);
    }
  }, {
    key: 'chars',
    value: function chars() {
      return propMap.get(this).charset.chars();
    }
  }, {
    key: 'use',
    value: function use(charset) {
      if (!(charset instanceof CharSet)) {
        throw new Error('Invalid CharSet');
      }
      propMap.get(this).charset = charset;
    }
  }, {
    key: 'useChars',
    value: function useChars(chars) {
      if (!(typeof chars === 'string' || chars instanceof String)) {
        throw new Error('Invalid chars: Must be string');
      }
      this.use(new CharSet(chars));
    }
  }], [{
    key: 'bits',
    value: function bits(total, risk) {
      if (total === 0) {
        return 0;
      }

      var log2 = _log2.default;


      var N = void 0;
      if (total < 1000) {
        N = log2(total) + log2(total - 1);
      } else {
        N = 2 * log2(total);
      }
      return N + log2(risk) - 1;
    }
  }]);
  return _class;
}();

exports.default = _class;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VudHJvcHkuanMiXSwibmFtZXMiOlsiQ3J5cHRvIiwicmVxdWlyZSIsIldlYWtNYXAiLCJDaGFyU2V0IiwiZGVmYXVsdCIsImNoYXJzZXQ2NCIsImNoYXJzZXQzMiIsImNoYXJzZXQxNiIsImNoYXJzZXQ4IiwiY2hhcnNldDQiLCJjaGFyc2V0MiIsInByb3BNYXAiLCJCSVRTX1BFUl9CWVRFIiwiZW5kaWFuQnl0ZU51bSIsImJ1ZjMyIiwiVWludDMyQXJyYXkiLCJidWY4IiwiVWludDhBcnJheSIsImJ1ZmZlciIsInN0cmluZ1dpdGhCeXRlcyIsImJpdExlbiIsImJ5dGVzIiwiY2hhcnNldCIsImJpdHNQZXJDaGFyIiwiZ2V0Qml0c1BlckNoYXIiLCJjb3VudCIsIk1hdGgiLCJjZWlsIiwibmVlZCIsImxlbmd0aCIsIkVycm9yIiwiY2hhcnNQZXJDaHVuayIsImdldENoYXJzUGVyQ2h1bmsiLCJjaHVua3MiLCJmbG9vciIsInBhcnRpYWxzIiwibmR4Rm4iLCJnZXROZHhGbiIsImNoYXJzIiwiZ2V0Q2hhcnMiLCJzdHJpbmciLCJjaHVuayIsInNsaWNlIiwibmR4IiwiY3J5cHRvQnl0ZXMiLCJCdWZmZXIiLCJmcm9tIiwicmFuZG9tQnl0ZXMiLCJCWVRFU19VU0VEX1BFUl9SQU5ET01fQ0FMTCIsInJhbmRDb3VudCIsImFsbG9jIiwiZGF0YVZpZXciLCJEYXRhVmlldyIsIkFycmF5QnVmZmVyIiwick51bSIsInNldEZsb2F0NjQiLCJyYW5kb20iLCJuIiwiZkJ5dGVOdW0iLCJiQnl0ZU51bSIsImdldFVpbnQ4IiwiYXJnIiwidW5kZWZpbmVkIiwiU3RyaW5nIiwiaGlkZVByb3BzIiwic2V0IiwiZ2V0IiwiYnl0ZXNOZWVkZWQiLCJ1c2UiLCJ0b3RhbCIsInJpc2siLCJsb2cyIiwiTiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBTUEsU0FBU0MsUUFBUSxRQUFSLENBQWY7QUFDQSxJQUFNQyxVQUFVRCxRQUFRLFVBQVIs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WixFQUFrQjVDLE9BQWxCLEdBQTRCQSxPQUE1QjtBQUNEOzs7NkJBRVFnQixLLEVBQU87QUFDZCxVQUFJLEVBQUUsT0FBT0EsS0FBUCxLQUFpQixRQUFqQixJQUE2QkEsaUJBQWlCeUIsTUFBaEQsQ0FBSixFQUE2RDtBQUMzRCxjQUFNLElBQUlqQyxLQUFKLENBQVUsK0JBQVYsQ0FBTjtBQUNEO0FBQ0QsV0FBS3NDLEdBQUwsQ0FBUyxJQUFJakUsT0FBSixDQUFZbUMsS0FBWixDQUFUO0FBQ0Q7Ozt5QkFsRVcrQixLLEVBQU9DLEksRUFBTTtBQUN2QixVQUFJRCxVQUFVLENBQWQsRUFBaUI7QUFBRSxlQUFPLENBQVA7QUFBVTs7QUFETixVQUdmRSxJQUhlOzs7QUFLdkIsVUFBSUMsVUFBSjtBQUNBLFVBQUlILFFBQVEsSUFBWixFQUFrQjtBQUNoQkcsWUFBSUQsS0FBS0YsS0FBTCxJQUFjRSxLQUFLRixRQUFRLENBQWIsQ0FBbEI7QUFDRCxPQUZELE1BRU87QUFDTEcsWUFBSSxJQUFJRCxLQUFLRixLQUFMLENBQVI7QUFDRDtBQUNELGFBQVFHLElBQUlELEtBQUtELElBQUwsQ0FBTCxHQUFtQixDQUExQjtBQUNEIiwiZmlsZSI6ImVudHJvcHkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBDcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKVxuY29uc3QgV2Vha01hcCA9IHJlcXVpcmUoJ3dlYWstbWFwJylcblxuY29uc3QgeyBkZWZhdWx0OiBDaGFyU2V0IH0gPSByZXF1aXJlKCcuL2NoYXJzZXQnKVxuXG5leHBvcnQgY29uc3QgY2hhcnNldDY0ID0gbmV3IENoYXJTZXQoJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5LV8nKVxuZXhwb3J0IGNvbnN0IGNoYXJzZXQzMiA9IG5ldyBDaGFyU2V0KCcyMzQ2Nzg5YmRmZ2hqbW5wcXJ0QkRGR0hKTE1OUFFSVCcpXG5leHBvcnQgY29uc3QgY2hhcnNldDE2ID0gbmV3IENoYXJTZXQoJzAxMjM0NTY3ODlhYmNkZWYnKVxuZXhwb3J0IGNvbnN0IGNoYXJzZXQ4ID0gbmV3IENoYXJTZXQoJzAxMjM0NTY3JylcbmV4cG9ydCBjb25zdCBjaGFyc2V0NCA9IG5ldyBDaGFyU2V0KCdBVENHJylcbmV4cG9ydCBjb25zdCBjaGFyc2V0MiA9IG5ldyBDaGFyU2V0KCcwMScpXG5cbmNvbnN0IHByb3BNYXAgPSBuZXcgV2Vha01hcCgpXG5cbmNvbnN0IEJJVFNfUEVSX0JZVEUgPSA4XG5cbmNvbnN0IGVuZGlhbkJ5dGVOdW0gPSAoKCkgPT4ge1xuICBjb25zdCBidWYzMiA9IG5ldyBVaW50MzJBcnJheSgxKVxuICBjb25zdCBidWY4ID0gbmV3IFVpbnQ4QXJyYXkoYnVmMzIuYnVmZmVyKVxuICBidWYzMlswXSA9IDB4ZmZcbiAgcmV0dXJuIChidWY4WzBdID09PSAweGZmKSA/IFsyLCAzLCA0LCA1LCA2LCA3XSA6IFswLCAxLCAyLCAzLCA2LCA3XVxufSkoKVxuXG5jb25zdCBzdHJpbmdXaXRoQnl0ZXMgPSAoYml0TGVuLCBieXRlcywgY2hhcnNldCkgPT4ge1xuICBpZiAoYml0TGVuIDw9IDApIHsgcmV0dXJuICcnIH1cblxuICBjb25zdCBiaXRzUGVyQ2hhciA9IGNoYXJzZXQuZ2V0Qml0c1BlckNoYXIoKVxuICBjb25zdCBjb3VudCA9IE1hdGguY2VpbChiaXRMZW4gLyBiaXRzUGVyQ2hhcilcbiAgaWYgKGNvdW50IDw9IDApIHsgcmV0dXJuICcnIH1cblxuICBjb25zdCBuZWVkID0gTWF0aC5jZWlsKGNvdW50ICogKGJpdHNQZXJDaGFyIC8gQklUU19QRVJfQllURSkpXG4gIGlmIChieXRlcy5sZW5ndGggPCBuZWVkKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnN1ZmZpY2llbnQgYnl0ZXM6IG5lZWQgJHtuZWVkfSBhbmQgZ290ICR7Ynl0ZXMubGVuZ3RofWApXG4gIH1cblxuICBjb25zdCBjaGFyc1BlckNodW5rID0gY2hhcnNldC5nZXRDaGFyc1BlckNodW5rKClcbiAgY29uc3QgY2h1bmtzID0gTWF0aC5mbG9vcihjb3VudCAvIGNoYXJzUGVyQ2h1bmspXG4gIGNvbnN0IHBhcnRpYWxzID0gY291bnQgJSBjaGFyc1BlckNodW5rXG5cbiAgY29uc3QgbmR4Rm4gPSBjaGFyc2V0LmdldE5keEZuKClcbiAgY29uc3QgY2hhcnMgPSBjaGFyc2V0LmdldENoYXJzKClcblxuICBsZXQgc3RyaW5nID0gJydcbiAgZm9yIChsZXQgY2h1bmsgPSAwOyBjaHVuayA8IGNodW5rczsgY2h1bmsgKz0gMSkge1xuICAgIGZvciAobGV0IHNsaWNlID0gMDsgc2xpY2UgPCBjaGFyc1BlckNodW5rOyBzbGljZSArPSAxKSB7XG4gICAgICBjb25zdCBuZHggPSBuZHhGbihjaHVuaywgc2xpY2UsIGJ5dGVzKVxuICAgICAgc3RyaW5nICs9IGNoYXJzW25keF1cbiAgICB9XG4gIH1cbiAgZm9yIChsZXQgc2xpY2UgPSAwOyBzbGljZSA8IHBhcnRpYWxzOyBzbGljZSArPSAxKSB7XG4gICAgY29uc3QgbmR4ID0gbmR4Rm4oY2h1bmtzLCBzbGljZSwgYnl0ZXMpXG4gICAgc3RyaW5nICs9IGNoYXJzW25keF1cbiAgfVxuICByZXR1cm4gc3RyaW5nXG59XG5cbmNvbnN0IGNyeXB0b0J5dGVzID0gY291bnQgPT4gQnVmZmVyLmZyb20oQ3J5cHRvLnJhbmRvbUJ5dGVzKGNvdW50KSlcblxuY29uc3QgcmFuZG9tQnl0ZXMgPSAoY291bnQpID0+IHtcbiAgY29uc3QgQllURVNfVVNFRF9QRVJfUkFORE9NX0NBTEwgPSA2XG4gIGNvbnN0IHJhbmRDb3VudCA9IE1hdGguY2VpbChjb3VudCAvIEJZVEVTX1VTRURfUEVSX1JBTkRPTV9DQUxMKVxuXG4gIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5hbGxvYyhjb3VudClcbiAgY29uc3QgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcobmV3IEFycmF5QnVmZmVyKEJJVFNfUEVSX0JZVEUpKVxuICBmb3IgKGxldCByTnVtID0gMDsgck51bSA8IHJhbmRDb3VudDsgck51bSArPSAxKSB7XG4gICAgZGF0YVZpZXcuc2V0RmxvYXQ2NCgwLCBNYXRoLnJhbmRvbSgpKVxuICAgIGZvciAobGV0IG4gPSAwOyBuIDwgQllURVNfVVNFRF9QRVJfUkFORE9NX0NBTEw7IG4gKz0gMSkge1xuICAgICAgY29uc3QgZkJ5dGVOdW0gPSBlbmRpYW5CeXRlTnVtW25dXG4gICAgICBjb25zdCBiQnl0ZU51bSA9IChyTnVtICogQllURVNfVVNFRF9QRVJfUkFORE9NX0NBTEwpICsgblxuICAgICAgaWYgKGJCeXRlTnVtIDwgY291bnQpIHtcbiAgICAgICAgYnVmZmVyW2JCeXRlTnVtXSA9IGRhdGFWaWV3LmdldFVpbnQ4KGZCeXRlTnVtKVxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gYnVmZmVyXG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIHtcbiAgY29uc3RydWN0b3IoYXJnKSB7XG4gICAgbGV0IGNoYXJzZXRcbiAgICBpZiAoYXJnID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGNoYXJzZXQgPSBjaGFyc2V0MzJcbiAgICB9IGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIENoYXJTZXQpIHtcbiAgICAgIGNoYXJzZXQgPSBhcmdcbiAgICB9IGVsc2UgaWYgKCh0eXBlb2YgYXJnID09PSAnc3RyaW5nJyB8fCBhcmcgaW5zdGFuY2VvZiBTdHJpbmcpKSB7XG4gICAgICBjaGFyc2V0ID0gbmV3IENoYXJTZXQoYXJnKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgYXJnOiBtdXN0IGJlIGVpdGhlciB2YWxpZCBDaGFyU2V0IG9yIHZhbGlkIGNoYXJzJylcbiAgICB9XG4gICAgY29uc3QgaGlkZVByb3BzID0ge1xuICAgICAgY2hhcnNldFxuICAgIH1cbiAgICBwcm9wTWFwLnNldCh0aGlzLCBoaWRlUHJvcHMpXG4gIH1cblxuICBzdGF0aWMgYml0cyh0b3RhbCwgcmlzaykge1xuICAgIGlmICh0b3RhbCA9PT0gMCkgeyByZXR1cm4gMCB9XG5cbiAgICBjb25zdCB7IGxvZzIgfSA9IE1hdGhcblxuICAgIGxldCBOXG4gICAgaWYgKHRvdGFsIDwgMTAwMCkge1xuICAgICAgTiA9IGxvZzIodG90YWwpICsgbG9nMih0b3RhbCAtIDEpXG4gICAgfSBlbHNlIHtcbiAgICAgIE4gPSAyICogbG9nMih0b3RhbClcbiAgICB9XG4gICAgcmV0dXJuIChOICsgbG9nMihyaXNrKSkgLSAxXG4gIH1cblxuICBzbWFsbElEKGNoYXJzZXQgPSBwcm9wTWFwLmdldCh0aGlzKS5jaGFyc2V0KSB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaW5nKDI5LCBjaGFyc2V0KVxuICB9XG5cbiAgbWVkaXVtSUQoY2hhcnNldCA9IHByb3BNYXAuZ2V0KHRoaXMpLmNoYXJzZXQpIHtcbiAgICByZXR1cm4gdGhpcy5zdHJpbmcoNjksIGNoYXJzZXQpXG4gIH1cblxuICBsYXJnZUlEKGNoYXJzZXQgPSBwcm9wTWFwLmdldCh0aGlzKS5jaGFyc2V0KSB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaW5nKDk5LCBjaGFyc2V0KVxuICB9XG5cbiAgc2Vzc2lvbklEKGNoYXJzZXQgPSBwcm9wTWFwLmdldCh0aGlzKS5jaGFyc2V0KSB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaW5nKDEyOCwgY2hhcnNldClcbiAgfVxuXG4gIHRva2VuKGNoYXJzZXQgPSBwcm9wTWFwLmdldCh0aGlzKS5jaGFyc2V0KSB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaW5nKDI1NiwgY2hhcnNldClcbiAgfVxuXG4gIHN0cmluZyhiaXRMZW4sIGNoYXJzZXQgPSBwcm9wTWFwLmdldCh0aGlzKS5jaGFyc2V0KSB7XG4gICAgY29uc3QgYnl0ZXNOZWVkZWQgPSBjaGFyc2V0LmJ5dGVzTmVlZGVkKGJpdExlbilcbiAgICByZXR1cm4gdGhpcy5zdHJpbmdXaXRoQnl0ZXMoYml0TGVuLCBjcnlwdG9CeXRlcyhieXRlc05lZWRlZCksIGNoYXJzZXQpXG4gIH1cblxuICBzdHJpbmdSYW5kb20oYml0TGVuLCBjaGFyc2V0ID0gcHJvcE1hcC5nZXQodGhpcykuY2hhcnNldCkge1xuICAgIGNvbnN0IGJ5dGVzTmVlZGVkID0gY2hhcnNldC5ieXRlc05lZWRlZChiaXRMZW4pXG4gICAgcmV0dXJuIHRoaXMuc3RyaW5nV2l0aEJ5dGVzKGJpdExlbiwgcmFuZG9tQnl0ZXMoYnl0ZXNOZWVkZWQpLCBjaGFyc2V0KVxuICB9XG5cbiAgc3RyaW5nV2l0aEJ5dGVzKGJpdExlbiwgYnl0ZXMsIGNoYXJzZXQgPSBwcm9wTWFwLmdldCh0aGlzKS5jaGFyc2V0KSB7XG4gICAgcmV0dXJuIHN0cmluZ1dpdGhCeXRlcyhiaXRMZW4sIGJ5dGVzLCBjaGFyc2V0KVxuICB9XG5cbiAgYnl0ZXNOZWVkZWQoYml0TGVuLCBjaGFyc2V0ID0gcHJvcE1hcC5nZXQodGhpcykuY2hhcnNldCkge1xuICAgIHJldHVybiBjaGFyc2V0LmJ5dGVzTmVlZGVkKGJpdExlbilcbiAgfVxuXG4gIGNoYXJzKCkge1xuICAgIHJldHVybiBwcm9wTWFwLmdldCh0aGlzKS5jaGFyc2V0LmNoYXJzKClcbiAgfVxuXG4gIHVzZShjaGFyc2V0KSB7XG4gICAgaWYgKCEoY2hhcnNldCBpbnN0YW5jZW9mIENoYXJTZXQpKSB7IHRocm93IG5ldyBFcnJvcignSW52YWxpZCBDaGFyU2V0JykgfVxuICAgIHByb3BNYXAuZ2V0KHRoaXMpLmNoYXJzZXQgPSBjaGFyc2V0XG4gIH1cblxuICB1c2VDaGFycyhjaGFycykge1xuICAgIGlmICghKHR5cGVvZiBjaGFycyA9PT0gJ3N0cmluZycgfHwgY2hhcnMgaW5zdGFuY2VvZiBTdHJpbmcpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY2hhcnM6IE11c3QgYmUgc3RyaW5nJylcbiAgICB9XG4gICAgdGhpcy51c2UobmV3IENoYXJTZXQoY2hhcnMpKVxuICB9XG59XG4iXX0=