'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _log = require('babel-runtime/core-js/math/log2');

var _log2 = _interopRequireDefault(_log);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var WeakMap = require('weak-map');

var _require = require('./lcm'),
    lcm = _require.default;

var propMap = new WeakMap();

var BITS_PER_BYTE = 8;

var genNdxFn = function genNdxFn(bitsPerChar) {
  // If BITS_PER_BYTEs is a multiple of bitsPerChar, we can slice off an integer number
  // of chars per byte.
  if (lcm(bitsPerChar, BITS_PER_BYTE) === BITS_PER_BYTE) {
    return function (chunk, slice, bytes) {
      var lShift = bitsPerChar;
      var rShift = BITS_PER_BYTE - bitsPerChar;
      return (bytes[chunk] << lShift * slice & 0xff) >> rShift;
    };
  }
  // Otherwise, while slicing off bits per char, we will possibly straddle a couple
  // of bytes, so a bit more work is involved

  var slicesPerChunk = lcm(bitsPerChar, BITS_PER_BYTE) / BITS_PER_BYTE;
  return function (chunk, slice, bytes) {
    var bNum = chunk * slicesPerChunk;

    var offset = slice * bitsPerChar / BITS_PER_BYTE;
    var lOffset = Math.floor(offset);
    var rOffset = Math.ceil(offset);

    var rShift = BITS_PER_BYTE - bitsPerChar;
    var lShift = slice * bitsPerChar % BITS_PER_BYTE;

    var ndx = (bytes[bNum + lOffset] << lShift & 0xff) >> rShift;

    var r1Bits = (rOffset + 1) * BITS_PER_BYTE;
    var s1Bits = (slice + 1) * bitsPerChar;

    var rShiftIt = (r1Bits - s1Bits) % BITS_PER_BYTE;
    if (rShift < rShiftIt) {
      ndx += bytes[bNum + rOffset] >> rShiftIt;
    }
    return ndx;
  };
};

var CharSet = function () {
  function CharSet(chars) {
    (0, _classCallCheck3.default)(this, CharSet);

    if (!(typeof chars === 'string' || chars instanceof String)) {
      throw new Error('Invalid chars: Must be string');
    }
    var length = chars.length;

    if (![2, 4, 8, 16, 32, 64].includes(length)) {
      throw new Error('Invalid char count: must be one of 2,4,8,16,32,64');
    }
    var bitsPerChar = Math.floor((0, _log2.default)(length));
    // Ensure no repeated characters
    for (var i = 0; i < length; i += 1) {
      var c = chars.charAt(i);
      for (var j = i + 1; j < length; j += 1) {
        if (c === chars.charAt(j)) {
          throw new Error('Characters not unique');
        }
      }
    }
    var privProps = {
      chars: chars,
      bitsPerChar: bitsPerChar,
      length: length,
      ndxFn: genNdxFn(bitsPerChar),
      charsPerChunk: lcm(bitsPerChar, BITS_PER_BYTE) / bitsPerChar
    };
    propMap.set(this, privProps);
  }

  (0, _createClass3.default)(CharSet, [{
    key: 'getChars',
    value: function getChars() {
      return propMap.get(this).chars;
    }
  }, {
    key: 'getBitsPerChar',
    value: function getBitsPerChar() {
      return propMap.get(this).bitsPerChar;
    }
  }, {
    key: 'getNdxFn',
    value: function getNdxFn() {
      return propMap.get(this).ndxFn;
    }
  }, {
    key: 'getCharsPerChunk',
    value: function getCharsPerChunk() {
      return propMap.get(this).charsPerChunk;
    }
  }, {
    key: 'length',
    value: function length() {
      return propMap.get(this).length;
    }
  }, {
    key: 'bytesNeeded',
    value: function bytesNeeded(bitLen) {
      var count = Math.ceil(bitLen / this.bitsPerChar());
      return Math.ceil(count * this.bitsPerChar() / BITS_PER_BYTE);
    }

    // Aliases

  }, {
    key: 'chars',
    value: function chars() {
      return this.getChars();
    }
  }, {
    key: 'ndxFn',
    value: function ndxFn() {
      return this.getNdxFn();
    }
  }, {
    key: 'bitsPerChar',
    value: function bitsPerChar() {
      return this.getBitsPerChar();
    }
  }]);
  return CharSet;
}();

exports.default = CharSet;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2NoYXJzZXQuanMiXSwibmFtZXMiOlsiV2Vha01hcCIsInJlcXVpcmUiLCJsY20iLCJkZWZhdWx0IiwicHJvcE1hcCIsIkJJVFNfUEVSX0JZVEUiLCJnZW5OZHhGbiIsImJpdHNQZXJDaGFyIiwiY2h1bmsiLCJzbGljZSIsImJ5dGVzIiwibFNoaWZ0IiwiclNoaWZ0Iiwic2xpY2VzUGVyQ2h1bmsiLCJiTnVtIiwib2Zmc2V0IiwibE9mZnNldCIsIk1hdGgiLCJmbG9vciIsInJPZmZzZXQiLCJjZWlsIiwibmR4IiwicjFCaXRzIiwiczFCaXRzIiwiclNoaWZ0SXQiLCJDaGFyU2V0IiwiY2hhcnMiLCJTdHJpbmciLCJFcnJvciIsImxlbmd0aCIsImluY2x1ZGVzIiwiaSIsImMiLCJjaGFyQXQiLCJqIiwicHJpdlByb3BzIiwibmR4Rm4iLCJjaGFyc1BlckNodW5rIiwic2V0IiwiZ2V0IiwiYml0TGVuIiwiY291bnQiLCJnZXRDaGFycyIsImdldE5keEZuIiwiZ2V0Qml0c1BlckNoYXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBTUEsVUFBVUMsUUFBUSxVQUFSLENBQWhCOztlQUV5QkEsUUFBUSxPQUFSLEM7SUFBUkMsRyxZQUFUQyxPOztBQUVSLElBQU1DLFVBQVUsSUFBSUosT0FBSixFQUFoQjs7QUFFQSxJQUFNSyxnQkFBZ0IsQ0FBdEI7O0FBRUEsSUFBTUMsV0FBVyxTQUFYQSxRQUFXLENBQUNDLFdBQUQsRUFBaUI7QUFDaEM7QUFDQTtBQUNBLE1BQUlMLElBQUlLLFdBQUosRUFBaUJGLGFBQWpCLE1BQW9DQSxhQUF4QyxFQUF1RDtBQUNyRCxXQUFPLFVBQUNHLEtBQUQsRUFBUUMsS0FBUixFQUFlQyxLQUFmLEVBQXlCO0FBQzlCLFVBQU1DLFNBQVNKLFdBQWY7QUFDQSxVQUFNSyxTQUFTUCxnQkFBZ0JFLFdBQS9CO0FBQ0EsYUFBTyxDQUFFRyxNQUFNRixLQUFOLEtBQWlCRyxTQUFTRixLQUEzQixHQUFxQyxJQUF0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RDs7O3VDQUVrQjtBQUNqQixhQUFPaEMsUUFBUW1DLEdBQVIsQ0FBWSxJQUFaLEVBQWtCRixhQUF6QjtBQUNEOzs7NkJBRVE7QUFDUCxhQUFPakMsUUFBUW1DLEdBQVIsQ0FBWSxJQUFaLEVBQWtCVixNQUF6QjtBQUNEOzs7Z0NBRVdXLE0sRUFBUTtBQUNsQixVQUFNQyxRQUFReEIsS0FBS0csSUFBTCxDQUFVb0IsU0FBUyxLQUFLakMsV0FBTCxFQUFuQixDQUFkO0FBQ0EsYUFBT1UsS0FBS0csSUFBTCxDQUFXcUIsUUFBUSxLQUFLbEMsV0FBTCxFQUFULEdBQStCRixhQUF6QyxDQUFQO0FBQ0Q7O0FBRUQ7Ozs7NEJBQ1E7QUFBRSxhQUFPLEtBQUtxQyxRQUFMLEVBQVA7QUFBd0I7Ozs0QkFDMUI7QUFBRSxhQUFPLEtBQUtDLFFBQUwsRUFBUDtBQUF3Qjs7O2tDQUNwQjtBQUFFLGFBQU8sS0FBS0MsY0FBTCxFQUFQO0FBQThCOzs7OztrQkF6RDNCbkIsTyIsImZpbGUiOiJjaGFyc2V0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgV2Vha01hcCA9IHJlcXVpcmUoJ3dlYWstbWFwJylcblxuY29uc3QgeyBkZWZhdWx0OiBsY20gfSA9IHJlcXVpcmUoJy4vbGNtJylcblxuY29uc3QgcHJvcE1hcCA9IG5ldyBXZWFrTWFwKClcblxuY29uc3QgQklUU19QRVJfQllURSA9IDhcblxuY29uc3QgZ2VuTmR4Rm4gPSAoYml0c1BlckNoYXIpID0+IHtcbiAgLy8gSWYgQklUU19QRVJfQllURXMgaXMgYSBtdWx0aXBsZSBvZiBiaXRzUGVyQ2hhciwgd2UgY2FuIHNsaWNlIG9mZiBhbiBpbnRlZ2VyIG51bWJlclxuICAvLyBvZiBjaGFycyBwZXIgYnl0ZS5cbiAgaWYgKGxjbShiaXRzUGVyQ2hhciwgQklUU19QRVJfQllURSkgPT09IEJJVFNfUEVSX0JZVEUpIHtcbiAgICByZXR1cm4gKGNodW5rLCBzbGljZSwgYnl0ZXMpID0+IHtcbiAgICAgIGNvbnN0IGxTaGlmdCA9IGJpdHNQZXJDaGFyXG4gICAgICBjb25zdCByU2hpZnQgPSBCSVRTX1BFUl9CWVRFIC0gYml0c1BlckNoYXJcbiAgICAgIHJldHVybiAoKGJ5dGVzW2NodW5rXSA8PCAobFNoaWZ0ICogc2xpY2UpKSAmIDB4ZmYpID4+IHJTaGlmdFxuICAgIH1cbiAgfVxuICAvLyBPdGhlcndpc2UsIHdoaWxlIHNsaWNpbmcgb2ZmIGJpdHMgcGVyIGNoYXIsIHdlIHdpbGwgcG9zc2libHkgc3RyYWRkbGUgYSBjb3VwbGVcbiAgLy8gb2YgYnl0ZXMsIHNvIGEgYml0IG1vcmUgd29yayBpcyBpbnZvbHZlZFxuXG4gIGNvbnN0IHNsaWNlc1BlckNodW5rID0gbGNtKGJpdHNQZXJDaGFyLCBCSVRTX1BFUl9CWVRFKSAvIEJJVFNfUEVSX0JZVEVcbiAgcmV0dXJuIChjaHVuaywgc2xpY2UsIGJ5dGVzKSA9PiB7XG4gICAgY29uc3QgYk51bSA9IGNodW5rICogc2xpY2VzUGVyQ2h1bmtcblxuICAgIGNvbnN0IG9mZnNldCA9IChzbGljZSAqIGJpdHNQZXJDaGFyKSAvIEJJVFNfUEVSX0JZVEVcbiAgICBjb25zdCBsT2Zmc2V0ID0gTWF0aC5mbG9vcihvZmZzZXQpXG4gICAgY29uc3Qgck9mZnNldCA9IE1hdGguY2VpbChvZmZzZXQpXG5cbiAgICBjb25zdCByU2hpZnQgPSBCSVRTX1BFUl9CWVRFIC0gYml0c1BlckNoYXJcbiAgICBjb25zdCBsU2hpZnQgPSAoc2xpY2UgKiBiaXRzUGVyQ2hhcikgJSBCSVRTX1BFUl9CWVRFXG5cbiAgICBsZXQgbmR4ID0gKChieXRlc1tiTnVtICsgbE9mZnNldF0gPDwgbFNoaWZ0KSAmIDB4ZmYpID4+IHJTaGlmdFxuXG4gICAgY29uc3QgcjFCaXRzID0gKHJPZmZzZXQgKyAxKSAqIEJJVFNfUEVSX0JZVEVcbiAgICBjb25zdCBzMUJpdHMgPSAoc2xpY2UgKyAxKSAqIGJpdHNQZXJDaGFyXG5cbiAgICBjb25zdCByU2hpZnRJdCA9IChyMUJpdHMgLSBzMUJpdHMpICUgQklUU19QRVJfQllURVxuICAgIGlmIChyU2hpZnQgPCByU2hpZnRJdCkge1xuICAgICAgbmR4ICs9IGJ5dGVzW2JOdW0gKyByT2Zmc2V0XSA+PiByU2hpZnRJdFxuICAgIH1cbiAgICByZXR1cm4gbmR4XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2hhclNldCB7XG4gIGNvbnN0cnVjdG9yKGNoYXJzKSB7XG4gICAgaWYgKCEodHlwZW9mIGNoYXJzID09PSAnc3RyaW5nJyB8fCBjaGFycyBpbnN0YW5jZW9mIFN0cmluZykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBjaGFyczogTXVzdCBiZSBzdHJpbmcnKVxuICAgIH1cbiAgICBjb25zdCB7IGxlbmd0aCB9ID0gY2hhcnNcbiAgICBpZiAoIVsyLCA0LCA4LCAxNiwgMzIsIDY0XS5pbmNsdWRlcyhsZW5ndGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgY2hhciBjb3VudDogbXVzdCBiZSBvbmUgb2YgMiw0LDgsMTYsMzIsNjQnKVxuICAgIH1cbiAgICBjb25zdCBiaXRzUGVyQ2hhciA9IE1hdGguZmxvb3IoTWF0aC5sb2cyKGxlbmd0aCkpXG4gICAgLy8gRW5zdXJlIG5vIHJlcGVhdGVkIGNoYXJhY3RlcnNcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSArPSAxKSB7XG4gICAgICBjb25zdCBjID0gY2hhcnMuY2hhckF0KGkpXG4gICAgICBmb3IgKGxldCBqID0gaSArIDE7IGogPCBsZW5ndGg7IGogKz0gMSkge1xuICAgICAgICBpZiAoYyA9PT0gY2hhcnMuY2hhckF0KGopKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDaGFyYWN0ZXJzIG5vdCB1bmlxdWUnKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHByaXZQcm9wcyA9IHtcbiAgICAgIGNoYXJzLFxuICAgICAgYml0c1BlckNoYXIsXG4gICAgICBsZW5ndGgsXG4gICAgICBuZHhGbjogZ2VuTmR4Rm4oYml0c1BlckNoYXIpLFxuICAgICAgY2hhcnNQZXJDaHVuazogbGNtKGJpdHNQZXJDaGFyLCBCSVRTX1BFUl9CWVRFKSAvIGJpdHNQZXJDaGFyXG4gICAgfVxuICAgIHByb3BNYXAuc2V0KHRoaXMsIHByaXZQcm9wcylcbiAgfVxuXG4gIGdldENoYXJzKCkge1xuICAgIHJldHVybiBwcm9wTWFwLmdldCh0aGlzKS5jaGFyc1xuICB9XG5cbiAgZ2V0Qml0c1BlckNoYXIoKSB7XG4gICAgcmV0dXJuIHByb3BNYXAuZ2V0KHRoaXMpLmJpdHNQZXJDaGFyXG4gIH1cblxuICBnZXROZHhGbigpIHtcbiAgICByZXR1cm4gcHJvcE1hcC5nZXQodGhpcykubmR4Rm5cbiAgfVxuXG4gIGdldENoYXJzUGVyQ2h1bmsoKSB7XG4gICAgcmV0dXJuIHByb3BNYXAuZ2V0KHRoaXMpLmNoYXJzUGVyQ2h1bmtcbiAgfVxuXG4gIGxlbmd0aCgpIHtcbiAgICByZXR1cm4gcHJvcE1hcC5nZXQodGhpcykubGVuZ3RoXG4gIH1cblxuICBieXRlc05lZWRlZChiaXRMZW4pIHtcbiAgICBjb25zdCBjb3VudCA9IE1hdGguY2VpbChiaXRMZW4gLyB0aGlzLmJpdHNQZXJDaGFyKCkpXG4gICAgcmV0dXJuIE1hdGguY2VpbCgoY291bnQgKiB0aGlzLmJpdHNQZXJDaGFyKCkpIC8gQklUU19QRVJfQllURSlcbiAgfVxuXG4gIC8vIEFsaWFzZXNcbiAgY2hhcnMoKSB7IHJldHVybiB0aGlzLmdldENoYXJzKCkgfVxuICBuZHhGbigpIHsgcmV0dXJuIHRoaXMuZ2V0TmR4Rm4oKSB9XG4gIGJpdHNQZXJDaGFyKCkgeyByZXR1cm4gdGhpcy5nZXRCaXRzUGVyQ2hhcigpIH1cbn1cblxuIl19